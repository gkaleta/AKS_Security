# Creating AAD apps for RBAC AD integration with Kubernetes

The following scripts will automate the creation of the relevant Service Principals, AAD apps and OAuth2 permissions required to provision an
AKS and AD integration cluster. See [Integrate Azure Active Directory with AKS](https://docs.microsoft.com/en-us/azure/aks/aad-integration)
for more info.

**You will need to have an admin role within your AAD tenant**

Note, you cannot programmatically grant admin consent to a Service Principal unless you are using Service Principal that already has had admin consent granted to it by a human being via the Grant Permissions button the Azure Portal. 

If you already have such a Service Principal, feel free to use that instead and skip the CreateSP.sh step. It must have the roles defined with the serviceManifest.json file.

For more info on the OAuth2 Permission Granting in AAD, see the legendary [Vittorio Bertocci's Azure Active Directory Application Model book free chapter](https://www.microsoftpressstore.com/articles/article.aspx?p=2473127&seqNum=2)

**If you have a server and native app already and just need to grant consent, run the script GrantOAuthToNativeApp.py**
**If you need to create new apps, run CreateSP.sh and ADk8.py as described below.**

## The scripts here will:

* Create a Server App with Service Principal that can read user profile in AAD. The roles are defined in the serviceManifest.json file
* Log on via the Server App and create a native app that will allow kubectl users to authenticate in AAD
* Grant Oauth2 permissions or admin consent to the native app

## To run:

1) az login in a terminal window and ensure your correct subscription is active via ```az account set ...```
2) Edit and Execute the bash script CreateSP.sh set the following:

```
** SUBSCRIPTION_ID and PASSWORD
```

3) Run pip install -r requirements.txt
4) Edit ADK8.py and set the following:
```
SERVER_APP_NAME='' # Must be populated manually - The name of your Server App
SERVER_APP_ID='' # Must be populated manually - The AppId or ClientId of your server app - generated by CreateSP.sh
SERVER_SECRET='' # Must be populated manually - The password or ClientSecret of your server app - manually set in CreateSP.sh

TENANT_ID='' # Must be populated manually - Your AD tenant id
CLIENT_APP_NAME='' # Must be populated manually - The name of your AAD native app
```
Ensure the Start and Expiry times in function grantOAuth2Permissions() are relevant to your policies.

5) Run the python script ADk8.py. 

## Provision the AKS Cluster


To be added: Provision AKS Cluster

